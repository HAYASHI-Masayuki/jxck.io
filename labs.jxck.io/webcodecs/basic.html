<!DOCTYPE html>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>WebCodecs DEMO</title>

<style>
</style>

<h1>WebCodecs DEMO</h1>

<ul>
  <li>Explainer: <a href=https://github.com/WICG/web-codecs/blob/master/explainer.md>https://github.com/WICG/web-codecs/blob/master/explainer.md</a>
  <li>CrBug: <a href=https://bugs.chromium.org/p/chromium/issues/detail?id=897297>https://bugs.chromium.org/p/chromium/issues/detail?id=897297</a>
</ul>

<video id=local autoplay></video>

<canvas width=640 height=480 id=remote></canvas>

<pre>
$ open -a /Applications/Google\ Chrome\ Canary.app --args --enable-blink-features=WebCodecs
</pre>

<script>
  'use strict';
  const $  = document.querySelector.bind(document)
  const $$ = document.querySelectorAll.bind(document)
  EventTarget.prototype.on = EventTarget.prototype.addEventListener

  document.on('DOMContentLoaded', async (e) => {
    console.log(e)

    // Canvas
    const $canvas = $('#remote')
    const ctx = $canvas.getContext('2d')

    // VideoStream
    const mediaStream = await navigator.mediaDevices.getUserMedia({video: true, audio: false})
    $('#local').srcObject = mediaStream
    const [videoTrack] = mediaStream.getVideoTracks()

    // Decoder
    const videoDecoder = new VideoDecoder({
      output: async function(chunk) {
        console.log(chunk)
        const imageBitmap = await chunk.createImageBitmap()
        console.log(imageBitmap)
        ctx.drawImage(imageBitmap, 0, 0)
      },
      error: function() {
        console.error(arguments)
      }
    })

    videoDecoder.configure({
      codec: 'vp8',
    })

    // Encoder
    const videoEncoder = new VideoEncoder({
      output: function(chunk) {
        console.log(chunk)
        videoDecoder.decode(chunk)
      },
      error: function() {
        console.error(arguments)
      }
    })
    await videoEncoder.configure({
      codec:     'vp8',
      framerate: 30,
      width:     640,
      height:    480,
    })


    const videoReader = (new VideoTrackReader(videoTrack))
    console.log(videoReader)
    videoReader.start(async (videoFrame) => {
      videoEncoder.encode(videoFrame)
    })

    setTimeout(() => {
      console.log('stop')
      videoReader.stop()
    }, 3000)

  })
</script>
