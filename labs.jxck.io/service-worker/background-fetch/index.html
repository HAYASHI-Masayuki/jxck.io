<!DOCTYPE html>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>Background Fetch DEMO</title>

<style>
a {
  font-size: 4em
}

circle-progress {
  display: inline-block;
  width: 50px
}
</style>

<h1>Background Fetch DEMO</h1>

<ul>
  <li><circle-progress max=100 value=0></circle-progress><a class=download href=./mozaic-ep61.mp3>download large mp3</a></li>
  <li><circle-progress max=100 value=0></circle-progress><a class=download href=./mozaic-ep00.mp3>download small mp3</a></li>
</ul>

<script type=module>
  'use strict';
  const $  = document.querySelector.bind(document)
  const $$ = document.querySelectorAll.bind(document)
  EventTarget.prototype.on = EventTarget.prototype.addEventListener

  import CircleProgress from '../../webcomponents/circle-progress.mjs'
  customElements.define('circle-progress', CircleProgress)

  document.on('DOMContentLoaded', async (e) => {
    console.log(await navigator.serviceWorker.register('worker.js'))

    $$('.download').forEach((download) => {
      download.addEventListener('click', async (e) => {
        e.preventDefault()
        const url = e.target.href
        console.log(e.target)

        const registration = await navigator.serviceWorker.ready
        console.log(registration)

        const head          = await fetch(url, {method: 'head'})
        const downloadTotal = head.headers.get('content-length')
        console.dir(downloadTotal)

        const $circle = e.target.previousElementSibling
        $circle.setAttribute('max', downloadTotal)

        // Promise<BackgroundFetchRegistration>
        // fetch(DOMString id,
        //       (RequestInfo or sequence<RequestInfo>) requests,
        //       optional BackgroundFetchOptions options);

        const task = await registration.backgroundFetch.fetch(url, [url], {downloadTotal})
        console.log(task)

        task.addEventListener('progress', (e) => {
          console.log(task.downloaded)
          $circle.setAttribute('value', task.downloaded)
        })
      })
    })

    //$('.fetch').addEventListener('click', async (e) => {
    //  e.preventDefault()
    //  const url = e.target.href
    //  console.log(url)
    //  const res = await fetch(url)
    //  console.log(res)
    //})
  })
</script>
