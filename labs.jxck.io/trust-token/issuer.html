<!DOCTYPE html>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">

<meta http-equiv=origin-trial content="Anha8n5weiE1qmmioiu3ohgnpbUHsZXnFDiI8DtT8BWr8qp5y/dAYYBOgNclM4Gj0DSKtmCzHFqg9oea3q3aNA4AAABfeyJvcmlnaW4iOiJodHRwczovL2p4Y2suaW86NDQzIiwiZmVhdHVyZSI6IlRydXN0VG9rZW5zIiwiZXhwaXJ5IjoxNjAyMDU5NzQxLCJpc1N1YmRvbWFpbiI6dHJ1ZX0=">

<title>Trust Token Issuer DEMO</title>

<style>
pre {
  background-color: #ccc;
}
</style>

<h1>Trust Token Issuer DEMO</h1>

<p>Are you a human ?</p>
<button id=yes>Yes</button>

<pre>
</pre>

<script>
  'use strict';
  const $  = document.querySelector.bind(document)
  const $$ = document.querySelectorAll.bind(document)
  EventTarget.prototype.on = EventTarget.prototype.addEventListener

  document.on('DOMContentLoaded', async (e) => {
    console.log(e)

    const res = await fetch('trust_token_key.json')
    const json = await res.json()
    console.log(json);

    const ISSUER = 'https://labs.jxck.io'
    const protocol_version = "TrustTokenV1"
    const batchsize        = 10
    const expiry           = "1622574000000000"

    const srrkey = json.srr_pub_key_base64
    const Y = json.pub_key_base64

    const COMMITMENT = {}
    COMMITMENT[ISSUER] = {
      protocol_version,
      batchsize,
      srrkey,
      "1": { Y, expiry }
    }

    const CMD = `/Applications/Google\\ Chrome\\ Canary.app/Contents/MacOS/Google\\ Chrome\\ Canary \\
  --additional-trust-token-key-commitments='${JSON.stringify(COMMITMENT)}' \\
  --auto-open-devtools-for-tabs \\
  --log-net-log=./trust_token_chromium_netlog.json \\
  --enable-logging=stderr \\
  --v=1 \\
  https://labs.jxck.io/trust-token/issuer.html \\
  &gt; canary_debuglog.txt 2&gt;&amp;1
  `

    $('pre').innerHTML = CMD;

    $('#yes').on('click', async () => {
      const res = await fetch(`/.well-known/trust-token`, {
        method: 'POST',
        trustToken: {
          type: 'token-request',
          issuer: ISSUER,
        }
      })

      console.log(res)
    })

    const token = await document.hasTrustToken(ISSUER)
    console.log(token)
  })
</script>
