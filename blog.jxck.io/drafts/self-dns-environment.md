# [dns] 自前 DNS 検証環境構築 : Intro

## Intro

最近、 Web 技術を追っているだけでも、 DNS に絡む話題を目にすることが増えた。

- DoH/DoT
- HTTPS Record
- ECH
- etc

特にプロトコルの最適化では、 「HTTP のヘッダよりも早く、 TLS の handshake で」、「TLS handshake よりも早く DNS Query で」というように、早めに情報をやりとりしたり、早めに暗号化を開始することで、 Security や Performance に寄与する提案が増えているため、必然とも思われる。

結果として、 DNS の知識が曖昧なままでは、それらの変化を正しく理解し対応していくことが難しくなりつつある。

DNS は手軽に運用できるサービスが多くあるが、それらが必ずしも新しい機能に対応しているとは限らず、アップデートを待たないと検証できないことも多い。

そこで、夏休みの自由研究として、これまで Cloud DNS に任せていた DNS の運用を自前で行い、そこで新しいプロトコルを積極的に試していく基盤を構築していきたい。


## 計画

想定では以下のように進めていく。まずは権威サーバからはじめ、試したい機能に応じてキャッシュも考えていく。

- DNS 選定
- DNS 構築
- DNS 移行
- 新機能系検証
  - HTTPS record
  - DoH
  - ECH
  - その他

連続したエントリにはならないだろうが、長い目で見て少しづつ実施していきたい。


## 現状の運用

現状のドメイン運用を一旦まとめておく。


### 保有ドメイン

このサーバで運用しているドメインは 2 つ。

- jxck.io の取得は 2013-08-13
- mozaic.fm の取得は 2015-03-09

もともと jxck.io と mozaic.fm は、扱っているレジストラが少なく、別々のレジストラで購入していた。

しかし、払い忘れがおこらないよう、両方に対応しているレジストラを探したが、 Netowl くらいしかなくそこに集約移管した。

支払いは、プリペイドのみで値段は以下。

- jxck.io: 7538 円/年
- mozaic.fm: 12636 円/年

ところが、プリペイドでの支払いは面倒臭い。毎年必要な金額をプリペイドにチャージして払うのは面倒だし、できればカードで自動更新されて欲しい。

そこで、 .io と .fm に対応してカードで自動更新できるところを探したところ、 iwantmyname を教えてもらった。


## iwantmyname

ここは対応しているドメインが多く、移管当時の試算では 110 円換算で年 3000 円以上浮く計算だった。

- jxck.io 6100 円($59)/年
- mozaic.fm 10890 円($99)/年

(しかし、今は円安がひどく 137 円とかなので逆転している。)

そこで、 iwantmyname に再度移管し、カードで自動支払いが可能になり、カードの期限内は放っておけるようになった。

Whois も Privacy Service があり、外部 DNS も普通に設定できるため、機能的に困っているところはない。


### 認証

細かいところだが、 iwantmyname は二段回認証を推奨しているため、有効にしようとすると Authy というアプリの利用を求められる。

QR が表示されるため Authy のアプリで読むと、普通の TOTP だった。それならいつも 1Password を使っているため、アプリを入れ替えたいと思ったが、なぜか Authy から変えることはできない仕様になっていた。

このためだけに Authy をキープしないといけないのは微妙に面倒だが、サポートに聞いてもそれが方針らしい。もしかしたら、初回登録時の QR コードを 1Password で読めば行けたのかもしれないが、アカウントを作り替える以外に試しようがないうえに、ドメインのアカウント作り替えは面倒なので Authy を使っている。


## DNS

DNS は、 VPS を借りている Sakura のものを使っていたが、その時点では A/AAAA くらいしか使ってなかったため、問題はなかった。しかし、 HTTPS Record に対応してなかったため、以下の検証タイミングで Cloud DNS に移行した。

- サイトの HTTP3 化と DNS HTTPS RR および Alt-Svc Header によるアドバタイズ | blog.jxck.io
  - https://blog.jxck.io/entries/2022-02-05/http3.html

このように、新しい機能を使うためにサービスのアップデートを待たないで済むことも、自前環境の利点だろう。

特に本サイトは、何かを試す目的があるので、多少の可溶性を犠牲にしても、マネージドな環境を脱しておきたい。特に Web に関しては、未だに素の Ubuntu の上に h2o を立てているおかげで、色々試すことができている。これを DNS にも広げたい。