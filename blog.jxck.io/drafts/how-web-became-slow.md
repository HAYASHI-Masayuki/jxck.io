# dev.to のパフォーマンス技術スタック解説


## Intro

「dev.to が速い」と盛り上がっており、中の技術者による技術的解説も公開されている。

しかし、それは概要レベルのものなので、より具体的にこのサイトが使っている技術スタックについて解説を試みる。

また、そこから dev.to が「なぜ遅くないのか」を解説する。

[Making dev.to insanely fast](https://dev.to/ben/making-devto-insanely-fast)


## SVG

Web においてトラフィックを支配しているのは画像か動画であることが多く、そのパケットを少しでも減らすのが常套手段である。

特にアイコンなどは、 GIF や PNG ではなく SVG を利用できればかなり小さくできる。

dev.to では、アイコンは基本的に SVG を使っており、さらに gzip で圧縮するという基本的な構成になっている。

スプライトしていないのは、圧縮効率を上げるためだろう。 H2 + SW との組み合わせも相性が良い。

ところが、単純なデザインのアイコンのわりに SVG ファイル自体が大きいようにも見える。

概ね 600B ~ 1KB 程度あるようだが、これは Illustrator で書いた SVG 独特の無駄なパスによるものだろう。

簡単な線で構成されるファイルは、そのまま素直な SVG になるとかなり小さくなる。

本サイトは、単純なアイコン SVG は全部手書きしているため、平均して 100~200KB 程度しかない。

- [画像最適化戦略 SVG/Font 編 | blog.jxck.io](https://blog.jxck.io/entries/2016-03-27/svg-font-base-ui.html)


## WebP

WebP は JPEG や PNG よりも小さいサイズで同等の画質を表現できるとして普及が進んでいる。

しかし、 WebP はまだ非対応環境も多いため、フォールバックの方法を考える必要がある。

dev.to では、 Chrome で見ると大半の画像が `content-type:image/webp` で返ってきていることがわかる。

しかし、 HTML 中の `<img>` タグに書かれた URL は、 `.jpeg` や `.png` の URL となっている。

このことから、ブラウザの Accept ヘッダを見て、 `image/webp` が含まれる場合のみ WebP を返していると想像される。

コンテントエンコーディングを使うのは方法の 1 つだが、画像は多くのフォーマットがあるため全ての UA が明示的に `image/webp` を入れるとは限らない。 (ex, `image/*`)

この場合は、 `<picture>` を用いることで、サーバが対応可能な選択肢を提示し、 UA に適切なものを選ばせることができる。

この方法なら、フォーマット以外に解像度なども端末の性能やバッテリー/Wifi 状態に合わせられることが期待できるし、 URL に拡張子を含むとしても実態と合わせられる。


- [画像最適化戦略 Picture 編 | blog.jxck.io](https://blog.jxck.io/entries/2016-03-25/picture.html)
- [画像最適化戦略 WebP 編 | blog.jxck.io](https://blog.jxck.io/entries/2016-03-26/webp.html)


## gzip

コンテンツを経路上で gzip 圧縮することは、多くのレスポンスに適応可能な汎用的な方法だ。(画像など効果が少ない、逆効果なものもある)

dev.to も基本的にはこれを行なっている。

ちなみに Google が提供する zopfli は、 gzip と同じ形式のままより高い圧縮率を出すことができる。

dev.to のコンテンツを Linux の gzip と zopfli コマンドで圧縮しなおして見たところ、サーバが返しているのは通常の gzip であるようだ。

zopfli は gzip よりも、時間をかけることで圧縮率を高める方式なので、オンデマンドの圧縮ではトレードオフがある。

一方、 WebP のようにコンテントネゴシエーションを行えば、 Accept-Encoding に `br` を含む Chrome などの場合は Brotli を用いることでより小さく圧縮可能だ。

こちらは、事前定義辞書を用いるため、圧縮時間はオンデマンドの適用にも耐えうるとされる。が dev.to では採用していないようだ。

- [Brotli を用いた静的コンテンツ配信最適化と Accept-Encoding: br について | blog.jxck.io](https://blog.jxck.io/entries/2017-08-19/content-encoding-brotli.html) 


## CDN

dev.to は Fastly を全体的に適用しているようだ。

今日では、 CDN には様々な機能があるが、基本的な CDN 導入のメリットの 1 つにエッジキャッシュを用いた **距離の最適化** がある。

dev.to のように、世界中からアクセスが来るサイトでは、そのユーザから物理的に近い場所からパケットを返せるのがも

特に、世界中からアクセスがくる




## 遅くしないためにできること

筆者は、「速くする」


Web は「速くする」のではなく、「遅くなっていく」という現象の積み重ねに対する返済を意味している。

例えば、何もしなければ遅くはならない。

example.com


しかし、そのサイトを作る本来の目的(コンテンツを公開する etc)のために、何かを追加する度に、その分のコストが追加されていくのだ。

コストの蓄積の結果「遅くなった」ものを、何らかの試作で速くするのも方法の 1 つだが、追加する度にそれによる「遅くなる」幅をなるべく減らすことを意識すると、その結果速くなると捉えると行うべきことがわかりやすい。

ここで意識すべきポイントは、具体的に以下の 3 つの視点に収まると筆者は考えている。

- なるべく小さく
- なるべく近く
- なるべく少なく


TODO: URL


これは、「高速化」ではなく「最適化」だと筆者は考えている。


## なるべく小さくする

dev.to で言えば以下が該当する

- WebP の採用
- gzip 圧縮
- WebFont の不採用


### WebP in Picture

画像や動画は常にトラフィックを支配的な立場にある。

同じものを表示する上でよりペイロードが小さい方法を採用したいが、ブラウザの対応が問題になる。

WebP は、 PNG や JPEG と比べると同等の画質をより小さいペイロードで表現できるため、各所で採用が進んでいる。

しかし、場合によっては WebP に対応していない User Agent を考慮することになるだろう。

TODO: caniuse

ブラウザにおいては、 Picture タグを用いてこれが実現できる。

TODO: ブログ


本サイトも、全ての画像を WebP で作り、 PNG をフォールバックとして提供している。
また、アイコンについては全て SVG にし、さらにそれを手書きすることで余計なパスを排除し、なるべく小さくしている。



## gzip/zopfli/brotli
