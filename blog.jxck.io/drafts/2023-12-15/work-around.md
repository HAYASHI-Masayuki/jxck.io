# [cookie][3pca] 3PCA 15 日目: Work Around

## Intro

このエントリは、 3rd Party Cookie Advent Calendar の 15 日目である。

- 3rd Party Cookie のカレンダー | Advent Calendar 2023 - Qiita
  - https://qiita.com/advent-calendar/2023/3rd-party-cookie

今回は ITP が始まったことで試行された、迂回方法について見ていく。


## 制限をどう迂回するか

ITP 以降、 3rd Party Cookie への制限が厳しくなると、従来トラッキングをしていた事業者たちは「トラッキングができる別の方法」を求めることになった。

今まで動いていた機能が動かなくなれば、代替手段を探したくなる気持ちはわからなくはない。トラッキングができなくなることで、広告のための分析精度が落ちると、収益が下がってサービスの継続性に関わる場合もあるだろう。

しかし、この連載を通して何度も言っているように、そもそもの目的は「*3rd Party Cookie を無くす*」ではなく「*トラッキングを防ぐ*」なのだ。

**「3rd Party Cookie が使えないなら、別の手法でトラッキングをしよう」という発想自体が間違っている。**

したがって、もしワークアラウンドが見つかれば、それも当然ブラウザによって塞がれることになる。

ITP が発表された直後、「弊社は独自の手法で、従来の 3rd Party Cookie と同等の精度でトラッキングできるソリューションをご提供します」といったサービスが散見された。

大抵の場合は 3rd Party Cookie ほどの精度が出ない眉唾なものが多いだろうが、もし本当に未知の手法が提供されているなら、それは解析され、報告され、最終的にはブラウザによって塞がれることになるだろう。その時点では使えても、半年後も有効かはわからない。

そして、多くの研究によってだいたいが既に塞がれているため、今の時点で精度の高いトラッキング手法が出てくることはおおよそないと思われる。

といった背景を知らなければ、そうしたサービスにうっかり大金を払って契約をしてしまうかもしれない。特に来年もまたそうしたサービスは散見されるだろう。払うのは自由だが、コストを掛けるべきが本当にそのサービスの導入なのかは一考の余地がある。

ITP に対して考えられた代表的なワークアラウンドは、以下のようなものがある。

- Bounce Tracking
- Link Decoration
- CNAME Cloaking
- Fingerprinting
- Super Cookie

今回は、それぞれがどのように防がれていったのかを解説していく。


## Bounce Tracking

例として、 X でポスト中のリンクをクリックすると、 `t.co` というドメインに一旦遷移し、そこでリダイレクトしてから目的の URL に遷移する作りになってる。

このように、「一旦リダイレクトを挟む」のは、X からすれば、`t.co`のログを見ることで、誰がどのポストを見て、どのサイトに離脱していったかを知ることができるというのは、なんとなくわかるだろう。

ところで、一瞬であっても `t.co` に遷移していれば、それが Top Level Domain になる。つまり、そこで保存/取得する Cookie は 1st Party Cookie だ。たとえそのリンクをクリックしたユーザが X にログインしてなかったとしても、 `t.co` の Cookie でトラッキングが可能ということになる。

3rd Party Context では送られない 3rd Party Cookie を、リダイレクトしてトラッカーの 1st Party Context でやりとりすることで、トラッキングを行うというこの手法を、「Bounce Tracking」と言う。

特に、複数のトラッカーでタライ回しのようにリダイレクトを繰り返しながら、各トラッカーがそのユーザの属性情報を追加していけば、トラッキングの精度を寄ってたかって高めることができるため、リダイレクトを瞬時にたくさん繰り返すようなサービスもあった。

このように、Bounce Tracking は、初期の ITP を迂回する手段として使われたりもしたが、後に Safari が「リダイレクトだけで通り抜けるのではなく、そのサイトを利用していない場合はトラッカーとみなす」という変更を入れたため、現在はもう塞がれている。

なお、Brave は「バウンスしている」と判定したら、間のリダイレクトを削除して最後のページに直接遷移する機能を入れ対策している。

- Bounce Tracking Meaning & Definition | Brave
  - https://brave.com/glossary/bounce-tracking

今では、 Safari に限らない全ブラウザ共通の課題として、どうやって防ぐかが議論されている。

- nav-tracking-mitigations/bounce-tracking-explainer.md at main - privacycg/nav-tracking-mitigations
  - https://github.com/privacycg/nav-tracking-mitigations/blob/main/bounce-tracking-explainer.md

注意点として、 Federation や SSO のように外部の IDP に一瞬行って、認証が確認できたらリダイレクトで戻ってくるようなケースは、 Bounce Tracking との見分けが難しく、巻き込まれて壊れることが懸念されている。

その場合、 IDP のページをリダイレクトではなく表示し、そこに「このアカウントで続行する」といったボタンなどの UI を置いて、それをユーザにクリックさせることで IDP 上でジェスチャーを発生させるといった対応が必要になる場合もある。


## Link Decoration

Facebook 内のリンクで外のサイトにいくと、遷移した先の URL に `fbclid=xxxxxxxxxxxxx...` というクエリが URL に付与されていることに気づくだろう。

これは、 URL クエリを付与して遷移することによって、その先に対応してる JS (Facebook のボタンなど)があれば、 JS でクエリを取得し、サイトの 1st Party Cookie として保存することで、トラッキングに使うという手法だ。

この手法を「Link Decoration」と言う。

ITP では「JS (document.cookie) で保存された Cookie は 1st Party であっても短期間で消える」という変更を入れたことで、すでに塞がれている。

また、クエリを送ってること自体も、トラッカーの判定に使われたり、削除してしまうといった話もある。しかしこれも、認証連携で Token をクエリに付与するケースが、巻き込んで壊れる可能性があるため、削除自体は簡単では無い。

認証連携など正規のユースケースを持つドメインは、ドメイン自体がトラッカー判定されないように、他の部分でトラッキングをしてないかに注意しておく必要があるだろう。


## Fingerprinting

3rd Party Cookie が無くても、トラッキングできると謳う製品の大半は、 Fingerprinting に依存している可能性が高い。

Fingerprinting は、ブラウザから取得できる情報をかき集めることで、ユーザごとに微妙に違う部分を手がかりに、ユーザを区別するという手法全般を指す。

この手法の精度は、いかにエントロピーの高い情報をブラウザから取得できるかにかかっている。そして、そのベースとなる情報は IP と User-Agent だろう。

IP だけでもかなり絞り込めはするが、同一ネットワークにいると同じ IP をポートを分けて使い回したり、時間が経つと別の人に割り当てられたりする。逆に同じ端末では、ブラウザが変わっても IP は変わらないだろう。従って IP のみで完璧な区別を実現できるとはいいがたい。

`User-Agent` 文字列は、使ってるマシンやブラウザ、そのバージョンなど細かい情報が入ってるため、同じネットワークにいても、 使っている OS やブラウザが違うと異なる値になる。

大抵はこの 2 つをベースにし、さらに精度を上げるための情報を追加で集めていく。例えば、デバイス固有な情報として `Accept-Language` の設定言語や、ローカルに保存されてるフォント情報、接続されたデバイス情報、 WebRTC や Canvas などエントロピーの高い情報が取得可能な API のコール結果などだ。

こうした Fingerprinting を防ぐ実装も、続々とブラウザに入っている。


### IP の秘匿

まず Apple が公開した IP への対応が、 Private Relay だ。これは Proxy を経由することで、サーバに見えるクライアントの IP を Proxy の IP に変えてしまうというものだ。インフラを利用するため有料ではあるが、 IP さえ変わってしまえばほとんど解決といってもいいレベルだろう。

Mozilla や Brave は VPN を提供することで同等のことを実現している。

また、 IP の秘匿を標準にするために、 IETF では OHTTP という仕様の標準化作業を行っており、 Chrome や Firefox が Proxy としての Fastly などと組んで対応していく予定を公開している。


## User-Agent String Reduction

`User-Agent` はそもそも情報量が多すぎることが度々問題になっている。

元々は、当時使われていた HTML の `<frame>` が、 Netscape では対応されていたが、 Mosaic は対応していなかった。そこで Web 開発者は、 Netscape か Mosaic かで分岐し `<frame>` の出し分けをしていた。そこに後発の IE が登場した時に `<frame>` に対応している分岐に入るために、 Netscape のふりをする必要があった。そうやって嘘を重ねた結果、今日に至る非常に長い UA 文字列が出来上がったのだ。

しかし、今では機能に対する分岐は Feature Detection が基本になるため、 UA の蓄積は一掃したい負債でもあった。そこで、今ではこのヘッダのエントロピーを下げていくための取り組みが始まっている。

Safari の場合は Version の値などを固定していくとで、以降のバージョンで文字列の変化する部分を減らすという "Freezing User-Agent" という取り組みが始まっている。もちろん、細かいバージョンが取れなくなると困るケースもあるが、大抵は特定バージョンのバグに起因する分岐であり、リリースサイクルが短くなったことでその影響も小さくなっている。

他のブラウザも概ね同意しており、 UA の代替としてもっと正確な情報を必要に応じて必要なだけ取る `Sec-CH-UA` を仕様化し、 Chrome を筆頭に対応が進んでいる。これは、デフォルトのいくつか以外は勝手には送られず、またブラウザも絞った情報しか出さないといったことで、 UA のようなことが起こらないようにしている。


## その他の API

特にデバイスに関連する API は、エントロピーの高い情報を取得しやすい。したがって、提案段階でそうしたセキュリティ面のレビューが行われ、 Fingerprint ベクターにならないように事前に議論されている。

既に実装されている API も、取得できる情報の粒度を下げたり、取得に制限をつけたり、 Prompt で許可を求めたりと、だいぶ塞がれつつある。


## Super Cookie

Super Cookie は、最初筆者も非常に驚いた、トラッカーの執念を感じる手法だ。

まず前提として、ブラウザのどこかに情報を保存でき、それがある程度の期間永続化され、かつ自動的に取得できるようなものであれば、トラッキングに応用が効く。そこで目がつけられたのが HSTS (HTTP Strict Transport Security)だ。

HSTS は、サイトが HTTPS に対応していることをブラウザに知らせ、次からは `http://` なリンクで遷移しても自動で `https://` にアップグレードさせるものだ。つまりこれは Origin ごとに 1bit の情報を保存しているとみなすことができる。

そこで `example.com` の下に `cloak00.example.com` から `cloakff.example.com` まで 256 個のサブドメインを用意したとする。

あるユーザには `00` で HSTS を、あるユーザには `01` で HSTS を、、とユーザごとに HSTS するサブドメインを変えていけば、 256 通りに区別できるというものだ。確認は、アクセスして HTTPS になっているかどうかで簡単に調べられる。

HSTS はそもそも HTTPS by Default というゴールに向けた過渡的な技術であり、 Chrome は既に最初から HTTPS で接続する方向に移行しつつあるため、今後は意味をなさなくなるだろう。


## CNAME Cloaking

これが今、トラッカーが最も期待している迂回技術だろう。

例えば、広告やアナリティクスなどなんらかのトラッカーを 3rd Party として利用している場合は、今後 3rd Party Cookie での連携ができなくなる。

そこで、そのトラッカーサービス自体を自分のサブドメインで運用してしまえば、 eTLD+1 が同じになり、 1st Party で連携できる。つまり `example.com` に対して `analytics.example.com` にトラッカーをデプロイしてしまえば、両者は SameSite になるといった手法だ。

しかし、自分でトラッカーになるサービスをデプロイ/メンテするのは負荷が高いため、ドメインを業者に預け、そこにデプロイしてもらう方が運用する側は楽だ。

ここで CNAME を用いる。CNAME で事業者のレコードを参照すれば、そのサブドメインを事業者が運用できるのだ。このように CNAME を預ける方法を CNAME Cloaking (コート預けるクロークのこと)と言う。

これも ITP 迂回の筆頭として問題になったので、 Safari ではもちろん対策がされている。CNAME の先を辿って、最終的に 3rd Party だったら Cookie 付与された Cookie を短命にするといったものだ。

その対策でさらに IP での Cloaking や、 NS そのものを委譲してしまうといった手法も提案されている。

ここまでいくと、ブラウザにとって対策は難しいだろうが、そもそも 3rd Party Cookie が使えないことよりも、事業者にドメインをのっとられるリスクの方が高くなってくるため、安易に選ぶべき方法では無いだろう。


### メールアドレスでの紐付け

広告団体の中には、ユーザの情報をメールアドレスで紐づけて共有するといった、過激な提案が出てくることもある。

もちろんそれは、 Web の技術を用いた手法では無いため、ブラウザでは対策できない。 Web 技術の範疇を超えた世界の話になるのだ。

そちらを担当するのが、ここまで解説したさまざまな法制度であり、当然規制されている行為にあたるであろうため、安易に手を出すと 3rd Party Cookie どころか事業の継続や罰金などのリスクが生じる可能性がある。


## イタチごっこ

この連載では、何度も繰り返し言っているが、問題は 3rd Party Cookie そのものではなく、トラッキングという行為自体なので、どんな方法でも「トラッキングできる手法」が見つかれば、その穴はブラウザベンダと標準化団体によって次々に対策されて埋められていくと思って良い。

そして、埋められていった先に残るのは、通常の Web 技術の枠を超えた、より高いリスクを伴う過激な手法への依存となっていく可能性がある。

そうした技術への依存は、ドメイン自体がブラウザにトラッカー判定されたり、司法により違反と判断され罰金が課せられるなど、より厳しい結果につながってしまう可能性があるのだ。

こうなった元凶として ITP を非難する声も多くあるが、今の時点で「トラッキングができない」ことに不平不満を言うのは「ユーザはタダで使える代わりに黙ってプライバシーを売り渡すべきだ」と公言しているのと、変わらなくなってしまっている。

筆者としてはこれを機に、迂回手段ではなく、時代に即した正しい姿は何なのか、実装だけでなくビジネスモデルも踏まえて、模索する方を推奨したい。