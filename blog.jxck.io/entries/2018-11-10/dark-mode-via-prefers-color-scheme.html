<!DOCTYPE html>
<html lang=ja>
<head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
  <meta charset=utf-8>
  <meta name=viewport content="width=device-width,initial-scale=1">

  <link rel=author    href=https://jxck.io/humans.txt>
  <link rel=manifest  href=/manifest.webmanifest>
  <link rel=alternate href=/feeds/atom.xml type=application/atom+xml title=blog.jxck.io>

  <link rel=canonical href="https://blog.jxck.io/entries/2018-11-10/dark-mode-via-prefers-color-scheme.html">
  <link rel=amphtml   href="https://blog.jxck.io/entries/2018-11-10/dark-mode-via-prefers-color-scheme.amp.html">
  <link rel=preload   type=font/woff2 as=font href=/assets/font/NotoSansCJKjp-Regular-Jxck-20200407.woff2 crossorigin>

  <script async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script>
  <script defer src=/assets/js/main.js></script>
  <script defer src=/assets/js/ga.js></script>
  <script defer src=/assets/js/highlight.pack.js></script>

  <link rel=icon             type =image/svg+xml sizes=any href=https://jxck.io/assets/img/jxck.svg>
  <link rel=icon             type =image/png sizes=256x256 href=https://jxck.io/assets/img/jxck.png>
  <link rel=apple-touch-icon type =image/png sizes=256x256 href=https://jxck.io/assets/img/jxck.png>

  <meta name=author              content=Jxck>
  <meta name=description         content="macOS Mojava は OS レベルで Dark Mode に対応した。しかし、 Web コンテンツは依然として白背景黒文字ベースのデザインが多く、結果ブラウザの中だけ眩しいという問題がある。Safari TP69 では、これにメディアクエリで対応するための `pre...">
  <meta name=keywords            content="media query,dark mode,css">
  <meta name=theme-color         content=#000000>

  <meta name=twitter:card        content=summary>
  <meta name=twitter:site        content=@jxck_>
  <meta name=twitter:url         content=https://blog.jxck.io/entries/2018-11-10/dark-mode-via-prefers-color-scheme.html>
  <meta name=twitter:title       content="prefers-color-scheme を用いた Dark Mode 対応と User Preference Media Features | blog.jxck.io">
  <meta name=twitter:description content="macOS Mojava は OS レベルで Dark Mode に対応した。しかし、 Web コンテンツは依然として白背景黒文字ベースのデザインが多く、結果ブラウザの中だけ眩しいという問題がある。Safari TP69 では、これにメディアクエリで対応するための `pre...">
  <meta name=twitter:image       content=https://jxck.io/assets/img/jxck.png>

  <meta property=og:type         content=article>
  <meta property=og:url          content=https://blog.jxck.io/entries/2018-11-10/dark-mode-via-prefers-color-scheme.html>
  <meta property=og:title        content="prefers-color-scheme を用いた Dark Mode 対応と User Preference Media Features | blog.jxck.io">
  <meta property=og:site_name    content=blog.jxck.io>
  <meta property=og:description  content="macOS Mojava は OS レベルで Dark Mode に対応した。しかし、 Web コンテンツは依然として白背景黒文字ベースのデザインが多く、結果ブラウザの中だけ眩しいという問題がある。Safari TP69 では、これにメディアクエリで対応するための `pre...">
  <meta property=og:image        content=https://jxck.io/assets/img/jxck.png>

  <script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id":"https://blog.jxck.io"
    },
    "headline": "prefers-color-scheme を用いた Dark Mode 対応と User Preference Media Features | blog.jxck.io",
    "image": [
      "https://jxck.io/assets/img/jxck.png",
      "https://logo.jxck.io/jxck.1200x1200.png"
    ],
    "datePublished": "2018-11-10T08:00:00+08:00",
    "dateModified": "2019-03-06T08:00:00+08:00",
    "author": {
      "@type": "Person",
      "name": "Jxck",
      "image": "https://jxck.io/assets/img/jxck.png"
    },
    "publisher": {
      "@type": "Organization",
      "name": "Jxck",
      "logo": {
        "@type": "ImageObject",
        "url": "https://logo.jxck.io/jxck.60x60.png",
        "height": 60,
        "width": 60
      }
    },
    "description": "macOS Mojava は OS レベルで Dark Mode に対応した。しかし、 Web コンテンツは依然として白背景黒文字ベースのデザインが多く、結果ブラウザの中だけ眩しいという問題がある。Safari TP69 では、これにメディアクエリで対応するための `pre..."
  }
  </script>

  <title>prefers-color-scheme を用いた Dark Mode 対応と User Preference Media Features | blog.jxck.io</title>
  <link rel=stylesheet property=stylesheet type=text/css href=/assets/css/body.css>
</head>
<body>
  <link rel=stylesheet property=stylesheet type=text/css href=/assets/css/header.css>
  <header>
    <nav>
      <ul>
        <li><a href=https://blog.jxck.io      ><img width=30 height=30 loading=eager src=/assets/img/blog.svg   title=blog   alt="blog logo" class=logo></a>
        <li><a href=/searches                 ><img width=30 height=30 loading=eager src=/assets/img/search.svg title=search alt=search></a>
        <li><a href="https://blog.jxck.io/entries/2018-11-10/dark-mode-via-prefers-color-scheme.amp.html#development=1" aria-label="amp version">
                                               <img width=30 height=30 loading=eager src=/assets/img/amp.svg    title=amp    alt="amp version"></a>
        <li><a href=.                         ><img width=30 height=30 loading=eager src=/assets/img/up.svg     title=up     alt="move to parent directory"></a>
        <li><a href=/feeds/atom.xml           ><img width=30 height=30 loading=eager src=/assets/img/rss.svg    title=rss    alt="rss feed"></a>
        <li><a href=https://jxck.io/humans.txt><img width=30 height=30 loading=eager src=/assets/img/humans.svg title=humans alt=huamns.txt></a>
        <li><a href=https://jxck.io           ><img width=30 height=30 loading=eager src=/assets/img/jxck.svg   title=jxck   alt="jxck logo" class=logo></a>
      </ul>
    </nav>
  </header>

  <link rel=stylesheet property=stylesheet type=text/css href=/assets/css/markdown.css>
  <link rel=stylesheet property=stylesheet type=text/css href=/assets/css/main.css>
  <main>
    <link rel=stylesheet property=stylesheet type=text/css href=/assets/css/info.css>
    <dl class=info>
      <div><dt>created_at</dt><dd><time class=created_at datetime=2018-11-10>2018-11-10</time></dd></div>
      <div><dt>updated_at</dt><dd><time class=updated_at datetime=2019-03-06>2019-03-06</time></dd></div>
      <div><dt class=tags>tags</dt><dd>[<a href="/tags/media%20query.html">media query</a><i>,</i><a href="/tags/dark%20mode.html">dark mode</a><i>,</i><a href="/tags/css.html">css</a>]</dd></div>
    </dl>

    <link rel=stylesheet property=stylesheet type=text/css href=/assets/css/article.css>
    <article>
      <h1><a href=/entries/2018-11-10/dark-mode-via-prefers-color-scheme.html>prefers-color-scheme を用いた Dark Mode 対応と User Preference Media Features</a></h1>
      <section>
        <h2 id="intro"><a href="#intro">Intro</a></h2>
        <p>macOS Mojava は OS レベルで Dark Mode に対応した。
        <p>しかし、 Web コンテンツは依然として白背景黒文字ベースのデザインが多く、結果ブラウザの中だけ眩しいという問題がある。
        <p><a href="https://webkit.org/blog/8475/release-notes-for-safari-technology-preview-68/">Safari TP69</a> では、これにメディアクエリで対応するための <code translate="no">prefers-color-scheme</code> が実装された。
        <p>これを用いた DarkMode 対応と、本ブログの DarkMode 対応、および策定中の User Preference Media Features について解説する。
      </section>
      <section>
        <h2 id="update"><a href="#update">Update</a></h2>
        <ul>
          <li>画像の対応について追記した
          <li>Code Block の対応について追記した
          <li>
            2019/1 に Chrome の Intents が出された。<ul>
              <li><a href="https://groups.google.com/a/chromium.org/forum/#!msg/blink-dev/Muw0N43ntSw/WZZZI7w7DQAJ">Intent to Implement: Media Queries: prefers-color-scheme feature</a>
              <li><a href="https://groups.google.com/a/chromium.org/forum/#!msg/blink-dev/NZ3c9d4ivA8/BIHFbOj6DAAJ">Intent to Implement and Ship: CSS prefers-reduced-motion media query</a>
            </ul>
          </li>
        </ul>
      </section>
      <section>
        <h2 id="dark-mode"><a href="#dark-mode">Dark Mode</a></h2>
        <p>多くのディスプレイコンテンツは、背景を白、文字を黒にしたデザイン(Light Mode)が多い。
        <p>しかし、暗い場所での閲覧時に目への負荷を下げる目的で、背景を黒、文字を白に反転したデザインが用意され、ユーザが好みで切り替えられるようにしたアプリケーションも増えた。
        <p>macOS Mojava らは、 OS レベルで Dark Mode を有効にできるようオプションが追加され、これによって多くのアプリケーションのデザインが切り替わるようになった。
        <p>筆者は黒背景のターミナル上に居る時間が長いため、ブラウザと切り替えた時の光の強さの変化がずっと気になっていたが、 OS 全体を Dark Mode にした結果より一層ブラウザが眩しく感じるようになった。
        <p>Safari は、 Mojava の Mode が Light/Dark どちらに設定されているかを取得する仕組みを検証しており、これを用いると OS の設定に合わせたデザインを提供できる。
      </section>
      <section>
        <h2 id="prefers-color-scheme"><a href="#prefers-color-scheme">prefers-color-scheme</a></h2>
        <p>Safari TP 69 では、 <code translate="no">prefers-color-scheme</code> を用いて Media Query でテーマごとに分岐した CSS を記述できるようになった。
        <link rel=stylesheet property=stylesheet type=text/css href=/assets/css/pre.css>
        <pre class=css><code translate="no">@media (prefers-color-scheme: light) {
  background-color: white;
  color: black;
}

@media (prefers-color-scheme: dark) {
  background-color: black;
  color: white;
}</code></pre>
        <p>多くの場合、現状のコンテンツが Ligth Mode と見なされるだろう。
        <p>その場合、差分のみを Dark Mode 用に書き、色を反転するデザインをあてれば良い。
        <p>しかし、今後 Dark 以外のテーマの出現や汎用性、メンテナンス性を考えると、カラーセットを Variables でまとめておき、切り替えるのが良いだろう。
        <pre class=css><code translate="no">@media (prefers-color-scheme: light) {
  --theme-base: white;
  --theme-font: black;
  --theme-accent: red;
}

@media (prefers-color-scheme: dark) {
  --theme-base: black;
  --theme-font: white;
  --theme-accent: pink;
}

body {
  background-color: var(--them-base);
  color: var(--them-font);
}

strong {
  color: var(--them-accent);
}</code></pre>
      </section>
      <section>
        <h2 id="画像"><a href="#画像">画像</a></h2>
        <p>CSS で色を付けているものは解決するが、問題は <code translate="no">&lt;img&gt;</code> タグの画像だった。
        <p>ページをダークモードにしても、画像が元のままだと浮いてしまうという問題があった。
        <p>画像には大きく二つの種類がある。
        <ul>
          <li>スクショなどの写真画像(png, jpg, webp)
          <li>ツールで書いた図(svg)
        </ul>
        <p>SVG は最悪作り直すことも可能だが、コストがかかるため難しい。
        <p>そこで、これらは CSS Filter で対応することにした。
        <section>
          <h3 id="ラスタ画像png-jpg-webp"><a href="#ラスタ画像png-jpg-webp">ラスタ画像(png, jpg, webp)</a></h3>
          <p>Dark Mode 時の画像がどうあるべきかを考えると難しい。
          <p>背景と文字については反転しているわけだが、画像の反転での <code translate="no">invert()</code> はネガのようになりより見にくくなってしまう。
          <p>そもそも Mode があるのは、なんらかの理由で「見やすさ」を切り替える目的があると考える。
          <p>Light Mode に対し Dark Mode があるのは、 Light Mode が「明るすぎる」「眩しい」という理由が挙げられるだろう。
          <p>すると、 Dark Mode 時の画像は、 Light Mode に対して暗くなっているべきだと考えられる。
          <p>そこで <code translate="no">grayscale()</code> を適用し、暗くする方法を取ることにした。
          <p>この <code translate="no">grayscale()</code> は引数を取り、 100% が完全な白黒になる。
          <p>注釈や赤線を引いたスクショもあるため、それらの色が認識でき、かつ明るさを抑えて先の dark mode の CSS デザインと混じる値を探す。
          <p>結果、以下に落ち着いた。
          <pre class=css><code translate="no">article img {
  filter: grayscale(50%);
}</code></pre>
        </section>
        <section>
          <h3 id="ベクタ画像svg"><a href="#ベクタ画像svg">ベクタ画像(svg)</a></h3>
          <p>ベクタは、基本白背景に対して黒の線や文字で作り、一部色を入れている。
          <p>これは、 <code translate="no">invert()</code> で反転させることで黒背景にすることが可能なので、黒背景にした dark mode とも合う。
          <p>しかし、そのままではやはり色が強くなりがちなので、ラスタと同じように <code translate="no">grayscale()</code> を適用することにした。
          <p>結果、以下に落ち着いた。
          <pre class=css><code translate="no">article img[src*=svg] {
  filter: invert(100%) grayscale(50%);
}</code></pre>
        </section>
        <section>
          <h3 id="画像についての備考"><a href="#画像についての備考">画像についての備考</a></h3>
          <p>本サイトが、そのそもモノクロデザインであるため、画像もモノクロにしてしまっても、なんとなくそれっぽく見える。
          <pre class=css><code translate="no">article img[src*=svg] {
  filter: invert(100%) grayscale(100%);
}

article img {
  filter: grayscale(100%);
}</code></pre>
          <p>しかし、それは本サイトがたまたまそうだっただけで、テーマカラーのあるサイトではそうはならないだろう。
          <p>そこで、ここまでの極端な設定は一旦避けて、前述のようにした。
          <p>画像については、今後も色々値を変えつつ試していきたい。
        </section>
      </section>
      <section>
        <h2 id="code-block"><a href="#code-block">Code Block</a></h2>
        <p>本サイトでは、コードスニペットにシンタックスハイライトを入れている。
        <p>ハイライト用のテーマを dark 用に用意するのも良いが、大変そうだったのでここも CSS filter を使うことにした。
        <p>ハイライト用に作ったカラーテーマは、そのまま <code translate="no">invert()</code> してもそれなりに違和感がなかったため、これを適用した。
        <pre class=css><code translate="no">p &gt; code,
pre &gt; code {
  filter: invert(100%);
}</code></pre>
      </section>
      <section>
        <h2 id="user-preference-media-features"><a href="#user-preference-media-features">User Preference Media Features</a></h2>
        <p>この <code translate="no">prefers-color-scheme</code> は MediaQueries Lv5 の User Preference Media Features という仕様に含まれ、まだ策定途中である。(current work は Lv4)
        <p>主に、ユーザ自身が望ましい閲覧設定を、コンテンツ側が取得して、デザインのヒントに利用するためのものである。
        <p>執筆時点では、 User Preference Media Features は以下の 4 が定義されている。
        <ul>
          <li>prefers-reduced-motion(reduce):       アニメーションなどの動きを減らす
          <li>prefers-reduced-transparency(reduce): 透過表現を減らす
          <li>prefers-contrast(high, low):          コントラストの高低を要求する
          <li>prefers-color-scheme(light, dark):    カラーテーマを指定する
        </ul>
        <p><a href="https://drafts.csswg.org/mediaqueries-5/#mf-user-preferences">Media Queries Level 5</a>
        <p>今回はこの color-scheme にのみフォーカスしたが、この仕様を見ればユーザが様々な閲覧環境を設定できるようになる可能性が想定でき、対応のバリエーションも増えるだろう。
        <p>もし今回 DarkMode に対応するために CSS に手を入れたり、新規に CSS を書く機会があるのであれば、将来こうした設定への対応をする可能性を考慮し、設計できるとより良いのではないだろうか。
      </section>
      <section>
        <h2 id="本サイトでの適用"><a href="#本サイトでの適用">本サイトでの適用</a></h2>
        <p>本サイトも色関連を variables でまとめ、 dark mode のみ切り替えるように CSS を適用した。
        <p>動作は Safari TP69 で確認している。
        <p>
          <picture>
            <source type=image/webp srcset=./dark-mode.webp#1346x783>
            <img loading=lazy src=./dark-mode.gif#1346x783 alt="dark mode support demo" title="">
          </picture>
        </p>
        <p>今後、新しくプロパティが実装された際には対応していく予定であり、それを見据えた CSS のリファクタリングをし、備えておきたいと考えている。
      </section>
    </article>
  </main>
  <hr>

  <link rel=stylesheet property=stylesheet type=text/css href=/assets/css/footer.css>
  <footer>
    <p class=copyright><small>Copyright &copy; 2016 <a href=/>Jxck</a>. All Rights Reserved.</small> See <small><a href=/policies/site.html>Site Policy</a> and <a href=/policies/privacy.html>Privacy Policy</a>.</small></p>
    <ins class=adsbygoogle data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-2902784829138215 data-ad-slot=9735419796></ins>
  </footer>
</body>
</html>