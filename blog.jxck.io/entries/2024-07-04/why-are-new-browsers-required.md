# [browser][web] なぜブラウザエンジンは 1 つではダメなのか? または Ladybird への期待

## Intro

他のブラウザエンジンをフォークせず、企業との取引に頼らず、寄付だけで作ることを宣言した新しいブラウザエンジン Ladybird の登場が話題になっている。

これがいかに価値のある取り組みなのか、書いてみたい。

また、ここから書く話は、 Web を漫然と眺めてきた筆者による N=1 の妄言だと思ってほしい。


## ブラウザエンジンとは

ブラウザは、「ブラウザ UI」と「ブラウザエンジン」と、大きく二つの構成要素に分けて考えることができる。

ブラウザエンジンとは、いわゆる Web 標準の技術を片っ端から実装した、ブラウザの土台となるものだ。

ビルドすれば、入力した URL からネットワーク経由でリソースを所得し、パースしてレンダリングして表示できる。そのための IETF RFC や WHATWG HTML や ECMAScript が実装されている、標準技術の結集だ。

その上に、例えばタブをグループ化したり、お気に入りをシンクしたり、そのためのアカウントを作ってログインしたり、 AI を連携させたりといった UI を追加すると、それがいわゆるユーザの使うブラウザになる。

この部分には、さまざまなビジネス上の観点や、プライバシーなどに対するポリシーが如実に現れる。

Chrome は、 OSS である Chromium の上に Google が作った UI が載ったものだ。 Safari は Webkit というエンジン、 Firefox は Gecko というエンジンの上に、それぞれの UI が載っている。

UI は、ビジネスや用途に直接結びつくため、各企業が自由に作って、多様で差別化が行われて良い。数が多くて、ユーザが自分に合ったものを選び、なんなら自由にカスタマイズして使えばいいのだ。

一方、ブラウザエンジンはそうはいかない。


## ブラウザエンジンの互換性

ブラウザエンジンは、同じ URL を入力すれば、同じように表示されることが求められる。表示だけではなく、 JS は同じ結果を返し、 CSS は同じ挙動をしてくれないと困る。

この実装間の互換性を保つためには、細かく仕様を規定し、標準となるテストを書き、各実装がそれを遵守することで初めて「実装間の互換性(どのエンジンでも同じように動く)」が達成される。

しかし、各ブラウザが業界シェアを奪い合っていた頃は、差別化のために多くの独自機能が実装され、「このブラウザでしか動かないページ」というのが、むしろビジネス面で喧伝されていた時代すらある。

ところが、そうした独自機能は最終的には互換性の問題を生み、開発者もユーザも苦しめることになるため、徐々に是正され、互換性の重視が広くブラウザと Web 開発者に根付いていった。

意識が根付いても、すでにリリースされたブラウザの挙動は、そう簡単には変えられない。特にバグがあったとしても、それを直してリリースすれば終わりといった、簡単な問題ではないのだ。

特に IE は、長いことそうしたバグを多く抱えており、本来ならば早く引退してブラウザを刷新したかった MS も、その IE の挙動に合わせて実装された多くのエンプラ製品が壊れないように、維持し続ける必要があった。 IE を直しても、それに合わせて企業はコードを直してくれないからだ。

すでにリリースされた挙動、それに合わせて作られたコンテンツ、仕様上の負の遺産、それら全てを少しづつ修正し、同じ間違いが起こらないようにテストリソースを整備し、その上で新しいケイパビリティを増やしていく。そうした地道な作業の積み重ねで、だいぶまともな Web が形作られて今に至るのだ。


## ブラウザエンジンの多様性

その作業が行われている期間に、 Web を支えていたエンジンは、大きく 4 つある。

- IE / Trident
- Firefox / Gecko
- Safari / Webkit
- Chrome / Chromium

もとを辿れば Gecko の前には Netscape があったり、 Chromium も Webkit のフォークから始まったりといろいろあるが、これら 4 つが「別のブラウザエンジン」としてそれぞれ開発を進めていたあたり、今から十数年前くらいからの話を振り返ろう。

後発の Chromium は、 Google がすでにリリースしていた、 Map/Gmail/Office などさまざまなサービスをフルに活用するためには、高速で軽量で豊富な機能を持つ独自のブラウザが必要として、開発が始まった。

そして、単に既存のページが表示できるだけでなく、 Ajax 以降にアプリ化が進んだ Web で、さらにリッチな表現を可能にするために、 HTML5 の一連の展開を迎える中で、豊富なリソースで業界を強く牽引した。

一番分が悪かったのはやはり IE だ。既存のバグを抱えながらも大きな刷新が難しく、新機能の開発も後手に周り、開発者からのヘイトはたまるが、シェアはあいかわらず大きく、依存しているエンプラコードは山のようにあり、それらをサポートしないといけない。最も IE を刷新したかったのは、他でもなく MS 自身だった。

Apple は、 HTML5 に反対とは言わずとも、そこまで積極的だった印象はない。アナリストは「Apple はアプリで儲けるので、 Web のプライオリティが低いのだ」という定説を支持し、それもなくはないかもしれないが、どちらかというとリソース配分の問題に筆者には思えた。 Google ほど潤沢なリソースはないため、フォーカスが必要だ。そして彼らは、目立つ新機能よりも「パフォーマンスとセキュリティ」にフォーカスしていたと思う。 JSC を使ってる Bun が、 V8 の Node よりも速いのも、こうした結果の現れだ。

Mozilla は、 Apple / Google / Microsoft のような営利企業と異なり、非営利団体として Firefox の開発をしていた。実際、この辺の話は割とややこしいので、組織の話はおいといて、スタンスとしては「営利団体である他のベンダが、自社の利益に Web を引き込む暴走を食い止める」といったニュアンスのスタンスがある。しかし、先立つものなくブラウザの開発はできないので寄付を募るが、実際の大きな収入は、 Firefox の検索エンジンを Google 検索にすることで得られる、 Google からのライセンス料だ。

この力関係は、表面的に見ると「Google が一人で Web を好きかって牛耳り、 Mozilla はそれに反対し、 Apple は我関せず、 IE はそれどころじゃない」みたいな構図に見えている人が多くおり、そういう口が当時の Twitter にはことあるごとに撒かれていた。

しかし、本当にそうだったら、 Google はもっと簡単に Web を手中に収めていただろう。


## ブラウザエンジンの均衡

ブラウザエンジンが Chromium だけになれば、開発者は 1 つのエンジンで開発すれば良いし、標準化も Google が行って、 Chrome が Ship して終わりなため、物事がシンプルになると思うかもしれない。

しかし、実際それを最も望んでないのは Google 自身だろう。

Web の過去の失敗からもわかるように、合意なく独自に進めていってもうまくいかないのは、火を見るよりも明らかだ。(Google も Gears という失敗を元に HTML5 をはじめた)。そして、合意を取るためには、相手が必要なのだ。相手がいない一人遊びは、そのプラットフォーム自体が反感を買い、 Web そのものがユーザに拒否され、終わってしまう可能性すらある。

「Web は誰のものでもない」は本来真実なのだが、 Google だけが段違いのリソースをそこに投入しているために、一般人に「Google が牛耳っている」と思われてしまう。そして、時には Google の中の人もそう勘違いする人間が出てしまうこともあるため、均衡を保つために他よりも気を使わざるをえない。

Firefox に出資するのは、確かに Google 検索を使うユーザを増やすというビジネス的な目的もあるだろうが、そんな出費をするなら、普通に考えて Firefox を潰す方が早いだろう。そうしないのは、均衡を保つために買い支えているというニュアンスが、実際のところ強いだろうと筆者は考えている。

標準についてもそうだ。 Chromium は Google がメインでメンテナンスしているが、立ち位置としては OSS だ。そして、そこに新しい機能を実装するには、必ずその機能を先んじて標準化することになっている。標準化は IETF であれ、 W3C であれ、 TC39 であれ合議制だ。そこには、各ブラウザベンダが集まり会議をし、時にはなんらかの合意を取る。 Chrome がどんなにリソースを投入していても、比例代表制になるわけではない。 TC39 の「最低 2 つの実装」を要件とする場合も、 V8 はあくまで一票でしかない。他のエンジンが、合意しつつも実装する余裕がなければ、 Chromium の人間か Igalia に頼んで、パッチを提供することも珍しくない。

実装にあたっても、 Chrome は必ず Safari と Firefox の Standard Position を聞きにいかないといけない。逆はない。そして、 Chrome が長大なプロセスをかけて整備した提案やコードも、 Safari や Firefox の人間の必ずしも納得できない説明で Deny されることもある。この意思決定に「Google からのライセンス料」の話など持ち出されても、「だったらもう少し忖度してあげ欲しいわ w」とすら思うほど、容赦ない。 Private Relay や Passkey のような重要な機能を相談もなく出して、標準化は後から行う Apple の方が、好き勝手やっているように見えるときだってある。

まあ、特に怪しいプロセスを押し通そうとする不届きものもいるが、基本はルールに乗っ取って進められる。 Chrome がやりたいことが、そのままできることばかりではない。このプロセスを知っていてなお「Chrome が好き勝手やっている」と思うのは、やはりかけているリソースが多く、作業量と成果が他のベンダーと比べて段違いなだけなことがほとんどで、その結果しか見えてないからだろう。

自分が 4 人チームに所属し、他の 3 人よりも 100 倍の成果を出せる状態でも、独立せずにチームでうまくやっていく状態を考えてみれば、大変さがわかると思う。

それだけ、エンジンの実装が複数あり、議論と合意形成が成立し、その多様性はありながら互換性は保たれている、という状態を維持するのは非常に大変かつ重要なのだ。それは Chrome にとっても、他のブラウザベンダにとっても同じだ。


## 均衡の崩れ

筆者はずっとこの均衡の崩れを懸念していた。

なぜなら、 Web が始まってから 30 年近い蓄積があり、年々新しい仕様が入り、その上で互換性を保つという、複雑性の塊のようんブラウザを、またゼロから新しく作るのは、人類には不可能だと思っているからだ。

具体的には「Mozilla の体力が尽きて、 Firefox が終わってしまったら、 Web はどうなるのか」そんなことを日々考えていた。

2015 年、Chrome チームを立ち上げに携わり、長年 PM をやっていた及川さんが Google を辞めた直後に、 mozaic.fm にお呼びして議論したのは、まさしく「人類が新しくブラウザを作れないとしたら、 Web はどうなるのか」という問題だった。

- ep20 Browser | mozaic.fm
  - https://mozaic.fm/episodes/20/browser.html

ここでは「ゼロから作る」とはどういうことかも議論している。例えば OpenSSL を使うのか TLS スタックをフルで書くのかといった匙加減はあるが、まあある程度既存のエコシステムの力を借りることはできる。それでも難しいだろうという話だった。

ところが、その後予想に反して Microsoft からこの均衡の崩れが始まった。

IE 卒業を視野に入れて、 EdgeHTML という新しいエンジンの開発が始まったのだ。この時点では、新しいエンジン開発という意味で歓迎できるものだった。特にレンダリング周りの実装は、革新的だったと当時のコードを読んだ人が言っていたのを記憶している。

しかし、数年の努力もむなしく EdgeHTML は開発をやめ、新しい Edge ブラウザは、 Chromium をブラウザエンジンに選んだ。

時を前後して Opera も Chromium ベースになり、 Brave, Vivaldi, Ark, Sidekick とさまざまな Chromium ベースのブラウザが生まれた。「ブラウザエンジン」の実装は増えないが、「ブラウザ」の実装はどんどん増えていったのだ。

確かに MS にしてみれば、今から EdgeHTML を Chromium, Gecko, Webkit レベルまで育てていくのは、非常にコストのかかるものだろう。その過程で使われる Edge も、他のブラウザと比べて不完全な時間が長く、その間にユーザからは IE 並のヘイトを集めてしまう可能性もある。

MS のビジネス的に、エンジンを育てることよりも、ブラウザ UI 側を育てて、 MS の各サービスと連携して顧客に価値を届ける方が理にかなっているのは事実だろう。現に Vertical Tab, Split View, Collections など便利な機能は多く提供され、 Bing 連携では Google を出し抜いて AI 連携を提供することにも成功している。

今の MS はベースの標準化と実装は Google にまかせ、その足りてない所として OpenUI に注力し、画面を使いやすくすることにフォーカスしているように思う。すでに実現した `<dialog>` や `popover` 、そしてその後ろに控えているさまざまな提案は、おそらく MS 製品の表現をリッチにすることに寄与していくだろう。

「ブラウザをゼロから実装するのは難しい」というのは、問いが間違っていたのだ。 Chromium というエコシステムの力を借りれば、「ブラウザ」はゼロから実装できる。実装できないのは「ブラウザエンジン」の方だった。


## さらなる危機

Trident と EdgeHTML が同時にリタイアし、現状は 3 つだ。

- Firefox / Gecko
- Safari / Webkit
- Chrome / Chromium

次なる危機は、またしても Firefox ではなく、 Safari の方に訪れている。

- Apple によるブラウザエンジン規制の緩和 | blog.jxck.io
  - https://blog.jxck.io/entries/2024-01-28/apple-sideloading.html

これまで Apple は、「iPhone 向けのブラウザアプリは Webkit ベースであること」という制限を課していた。

これはつまり、 iPhone にインストールできる Chrome も Firefox も、全部 Webkit の上にブラウザ UI をかぶせたものだったことを意味する。 Chrome を入れても動かない機能があったのは、それが Webkit に実装されてなかったからだ。

このような制限は、確かに囲い込みの側面はあるかもしれない。一方で、 Apple は Apple 製品全体にプライバシーやセキュリティについての強いクライテリアを用意している。 Apple の CM で「あなたの個人情報は守られてますか?」などと宣伝されているアレだ。これを実現するには、プラットフォームに強い制限が必要で、どんな邪悪なアプリを実装しようとしても、プラットフォーム側で守られていれば、顧客は安全というものだ。ブラウザも Webkit でできる以上のことができなければ、闇堕ちしたブラウザをユーザが掴まされることはない。

ここが iPhone が Android に対する差別化の一つとして提供している価値で、特に日本企業が高くても iPhone を社用に配る理由になっていたりする。

しかし、そう言ったポリシーも力を持つと反感を買う。反感を買えば規制が入り、今回は独占禁止の観点で規制の緩和が命令された。これは、技術的な話ではなく、文字通りフェアトレードの観点が強いため、その結果ユーザの安全がどの程度脅かされるかも、手数料を払わなくて済むベンダにとっては、取るに足らない言い訳程度にしか響かず、施行に向かっている。最初は EU だけだったが、日本はこのあたりの施策をだいたい EU からコピペしてるので、先日日本でも同等の規制緩和が指令された。

つまり、そう遠くない未来で iPhone に Chromium ベースの Chrome や、 Gecko ベースの Firefox がインストールできようになるとうことなのだ。

さて、 Web 開発者の視点に立てばどうだろうか? IE リタイア後は「次世代の IE」と揶揄される Safari がサポートされるのは、実際のところ iPhone のシェアが無視できないほど多いからという側面がある。Windows にもあえて Chrome を入れる人がいるように、 iPhone にもあえて Chrome を入れる人が増えたら、何が起こるだろうか?

もしインストール時に、デフォルトブラウザとして Safari, Chrome, Firefox から選択する画面が出るような構成になった時、ユーザは Safari を選び続けるだろうか?

もし、 PC と同じく iPhone での Chrome のシェアが増えても、サービスは Safari をサポートし続けられるだろうか?「Chrome を入れてアクセスしてください」というメッセージのもと、ストアのリンクを貼ったエラー画面だけを出すようにならないと、断言できるだろうか?

mozaic.fm では 7 年くらい前からブラウザの動向を毎月トラッキングしてきたが、最近の Safari の新機能開発の速度はこれまでよりも加速しており、今まで Safari がずっと後回しにしていたような機能が、どんどんリリースされている。 Safari のリリースノートも、どんどん長くなっている。穿ってみれば、プラットフォームの縛りがなくなったあとの、 Safari のシェアを案じた焦りとも見えなくはない。

このまま、より Chrome のシェアが一方的に増え、他のブラウザエンジンがビジネス的な理由から終わってしまうようなことがあれば、それはあらゆる側面で「よくないこと」であり、 Web の終わりの始まりになる可能性すらある。と筆者は懸念している。


## 新しいブラウザを作るという挑戦

Web は新しい実装を求めている。これは間違いない。

しかし、新しい実装が育つまで、進化を止めると言ったこともできない。

下手に手や資本を入れて、独立したプロジェクトのように初めても、世間は必ず穿った見方で批判をするため、新星の登場は、願って待つしかないのだ。

どのブラウザベンダも、そう思っているだろう。自分たちのシェアが脅かされることなど心配してない。むしろ、 Chrome にとっては、ある程度脅かしてくれるくらいがちょうどいいだろう。そもそも、 Chrome が買い切りの有料ソフトならまだしも、別にシェア自体が直接儲けにつながっているわけでもない。

標準化でも、エンジンが三つとすれば、多数決のできる最小人数まで減ってしまっている。あと一個終われば、もう多数決は成立しないのだ。

そして、新しいブラウザを作ろうという話は、無いわけではない。

Igalia は Firefox Reality からフォークした [Wolvic](https://wolvic.com/) というブラウザを作っているし

Ekioh は [Flow](https://www.ekioh.com/flow-browser/) というブラウザをスクラッチから作っている。

そして、最近出てきた [ladybird](https://ladybird.org/) もまた、他のブラウザのコードを使わず、寄付以外にビジネス的な支援を受けないで中立なブラウザを作ることを目指しているという。

こうした挑戦は、今の Web にとっては非常に重要だ。標準化で「実装」としてカウントされるような後発のブラウザエンジンは、しばらく現れてないし、その上で独自の UI も提供している Chromium ベースじゃない新しい「ブラウザ」もまた、最近あまり出てきてない。

「ゼロから実装は無理だと言われているが、我々はそれをやる」という意気込みも素晴らしい。

「ゼロから」がどこからなのかは、ここからは「他のブラウザのコードを借りない」という点しか読み取れない。例えば先の TLS の例で言えば、少なくとも BoringSSL は使わないんだろうか。 OpenSSL はありなのか、それとも TLS から自作するのか? QUIC は? WebRTC のための DTLS や SRTP はどうするんだろう。とネットワークだけでも気になることは色々ある。

もちろん、 Chromium をフォークせずに作れば、多少ライブラリが被っていたくらい気にならずに「新しいエンジン」と言えるだろう。本当に全部フルスクラッチしたら、完成はしても 10 年先といった事態になりかねない。そして 10 年経ったら、 Web は今以上に進化して結局追いつけないか、もうすでに手遅れになっている可能性もある。ここの塩梅だけはうまく落とし所を見つけて、できれば、 Baseline が求めるような WPT や Test262 を 80% 通すくらい互換性が保たれていて、現実的なタイムスパンでモダンブラウザの仲間入りをしてくれると嬉しい。

その上で、できればちゃんとシェアを獲得して、使われてほしい。

そして、それが最初から中立で、経済的な支援もなく開発が続くのであれば、そんなに良いことはないのだ。

これがどんだけ難しいことなのかは、筆者には想像もできない。

できることは手伝いたいと思うし、寄付サイトが落ちていたが、寄付もしたい。

Ladybird じゃなくてもいい。 Flow でも、それ以外の誰かでも、本気で新しいブラウザエンジンの開発に参入するなら、それは心から応援したい。


## Outro

「新しい Web ブラウザエンジンを作る。」

これは、 Web の大きさが、どのくらい高い解像度で認識できているかによって、感じるところの変わる目標だろう。

途中でその膨大さに挫けず、資金が途切れず、モチベが続き、 Web が終わってしまう前に

新しいブラウザエンジンが Baseline のリストに上がるような日が来ることを、心待ちにしたい。